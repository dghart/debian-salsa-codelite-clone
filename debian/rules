#!/usr/bin/make -f

PKD  = $(abspath $(dir $(MAKEFILE_LIST)))
PKG  = $(word 2,$(shell dpkg-parsechangelog -l$(PKD)/changelog | grep ^Source))
VER ?= $(shell dpkg-parsechangelog -l$(PKD)/changelog | perl -ne 'print $$1 if m{^Version:\s+(?:\d+:)?(\d.*)(?:\-\d+.*)};')

%:
	dh $@ --parallel

override_dh_auto_configure:
	dh_auto_configure -- -DCMAKE_INSTALL_LIBDIR=lib

# this is a hack so we can grab everything in /usr/share/codelite for
# codelite while splitting these directories away into separate plugins
#override_dh_install:
#	dh_install
#	rm -f debian/codelite/usr/share/codelite/src/$(UNITTEST_TARBALL)
#	cd debian/codelite/usr/share/codelite; \
#	rm -rf \
#		src/unittest*.tar.gz \
#		templates/gizmos \
#		templates/projects/UnitTest++ \
#		templates/formbuilder \
#		Runtime/templates/projects/dynamic-library-wx-enabled/dynamic-library-wx-enabled.project~ \
#		UnitTest++/Makefile \
#		templates/qmake
#	# Prune empty dirs
#	find debian/codelite/ -type d -empty -delete
#	find debian/codelite-plugins/ -type d -empty -delete
#
#override_dh_auto_clean:
#	[ -e UnitTest++/Makefile ] && \
#		mv UnitTest++/Makefile UnitTest++/Makefile.new
#	dh_auto_clean
#	find -name Makefile ! -wholename '*sdk*' -delete
#	rm -f fakeroot/DEBIAN/control
#	rm -rf $(CURDIR)/Runtime/src/UnitTest++
#	rm -rf $(CURDIR)/Runtime/src/unittest*.tar.gz
#	[ -e UnitTest++/Makefile.new ] && \
#		mv UnitTest++/Makefile.new UnitTest++/Makefile
#
#override_dh_auto_build:
#	cp -a UnitTest++ $(CURDIR)/Runtime/src
#	GZIP=-9fn tar -czf Runtime/src/$(UNITTEST_TARBALL) \
#		Runtime/src/UnitTest++
#	rm -rf $(CURDIR)/Runtime/src/UnitTest++
#	dh_auto_build
#
#override_dh_auto_install:
#	sed -i -e 's/\(install:.*\)\(uninstall\)\(.*\)/\1 \3/' Makefile
#	dh_auto_install

.PHONY: get-orig-source
## http://wiki.debian.org/onlyjob/get-orig-source
get-orig-source:
	uscan --noconf --verbose --rename --destdir=$(CURDIR) --check-dirname-level=0 --force-download --download-version $(VER) $(PKD)
