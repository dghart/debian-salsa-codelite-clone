From d6ba50d8b44c6da5e89fccf0051f3e8e55b30232 Mon Sep 17 00:00:00 2001
From: Eran <eran.ifrah@gmail.com>
Date: Sun, 8 Feb 2015 12:29:18 +0200
Subject: [PATCH] Fixed: exiting codelite without closing the workspace before
 should serialize the session properly (fixes:
 https://github.com/eranif/codelite/issues/641)

---
 LiteEditor.workspace |  4 ++--
 LiteEditor/frame.cpp | 24 +++++++++++++-----------
 2 files changed, 15 insertions(+), 13 deletions(-)

diff --git a/LiteEditor/frame.cpp b/LiteEditor/frame.cpp
index 40b1543..d592f7c 100644
--- a/LiteEditor/frame.cpp
+++ b/LiteEditor/frame.cpp
@@ -5053,6 +5053,19 @@ bool clMainFrame::ReloadExternallyModifiedProjectFiles()
 
 bool clMainFrame::SaveLayoutAndSession()
 {
+    // save the current session before closing
+    // We do this before 'CloseAll' so the session will 
+    // store the list of tabs
+    if(ManagerST::Get()->IsWorkspaceOpen()) {
+        wxString sessionName = WorkspaceST::Get()->GetWorkspaceFileName().GetFullPath();
+        SessionEntry session;
+        session.SetWorkspaceName(sessionName);
+        GetMainBook()->SaveSession(session);
+        ManagerST::Get()->GetBreakpointsMgr()->SaveSession(session);
+        SessionManager::Get().Save(sessionName, session);
+        SessionManager::Get().SetLastWorkspaceName(sessionName);
+    }
+    
     // make sure there are no 'unsaved documents'
     if(!GetMainBook()->CloseAll(true)) {
         return false;
@@ -5077,17 +5090,6 @@ bool clMainFrame::SaveLayoutAndSession()
     EditorConfigST::Get()->SetInteger(wxT("ShowNavBar"), m_mainBook->IsNavBarShown() ? 1 : 0);
     GetWorkspacePane()->SaveWorkspaceViewTabOrder();
 
-    // save the current session before closing
-    if(ManagerST::Get()->IsWorkspaceOpen()) {
-        wxString sessionName = WorkspaceST::Get()->GetWorkspaceFileName().GetFullPath();
-        SessionEntry session;
-        session.SetWorkspaceName(sessionName);
-        GetMainBook()->SaveSession(session);
-        ManagerST::Get()->GetBreakpointsMgr()->SaveSession(session);
-        SessionManager::Get().Save(sessionName, session);
-        SessionManager::Get().SetLastWorkspaceName(sessionName);
-    }
-
     // keep list of all detached panes
     wxArrayString panes = m_DPmenuMgr->GetDeatchedPanesList();
     DetachedPanesInfo dpi(panes);
